<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Check-in Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #FF4500 0%, #FF6600 25%, #FF8C00 50%, #FFA500 75%, #FFB347 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            color: #333;
        }

        .logo-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100px;
        }

        .logo {
            max-height: 100px;
            max-width: 300px;
            width: auto;
            height: auto;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .event-title {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #FF4500;
            font-weight: bold;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #FF6600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #FF4500;
        }

        .stat-label {
            font-size: 0.9em;
            color: #333;
            font-weight: 600;
        }

        .checkin-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .list-header {
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #FF6600;
            color: #FF4500;
            font-weight: bold;
        }

        .checkin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 8px 0;
            background: white;
            border-radius: 10px;
            transition: all 0.3s ease;
            border-left: 4px solid #FF6600;
            border: 2px solid #FFB347;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            color: #333;
        }

        .checkin-item.newest {
            background: #FFF8DC;
            border-left: 4px solid #FF4500;
            border: 2px solid #FF4500;
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.4);
            transform: scale(1.02);
            animation: shake 0.5s ease-in-out, newItemGlow 5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) scale(1.02); }
            25% { transform: translateX(-5px) scale(1.02); }
            75% { transform: translateX(5px) scale(1.02); }
        }

        @keyframes newItemGlow {
            0%, 100% { 
                background: #FFF8DC;
                box-shadow: 0 0 20px rgba(255, 69, 0, 0.4);
            }
            50% { 
                background: #FFEBCD;
                box-shadow: 0 0 30px rgba(255, 69, 0, 0.6);
            }
        }

        .person-info {
            flex: 1;
        }

        .person-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 3px;
            color: #333;
        }

        .person-details {
            font-size: 0.9em;
            color: #666;
        }

        .ticket-info {
            text-align: right;
            flex-shrink: 0;
        }

        .ticket-number {
            font-size: 1.4em;
            font-weight: bold;
            color: #FF4500;
            margin-bottom: 3px;
        }

        .checkin-time {
            font-size: 0.8em;
            color: #888;
        }

        .new-badge {
            background: #FF4500;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.7em;
            font-weight: bold;
            animation: pulse 1s infinite;
            margin-left: 10px;
            box-shadow: 0 2px 10px rgba(255, 69, 0, 0.5);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 2px 10px rgba(255, 69, 0, 0.5); }
            50% { transform: scale(1.1); box-shadow: 0 4px 20px rgba(255, 69, 0, 0.8); }
            100% { transform: scale(1); box-shadow: 0 2px 10px rgba(255, 69, 0, 0.5); }
        }

        .no-checkins {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
            font-weight: 600;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .connected {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }

        .disconnected {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .loading {
            background: rgba(255, 152, 0, 0.9);
            color: white;
        }

        .debug-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.8em;
            border: 2px solid #FF6600;
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .debug-info strong {
            color: #FF4500;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .event-title {
                font-size: 1.8em;
            }
            
            .logo {
                max-height: 80px;
            }
            
            .checkin-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .ticket-info {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <div class="logo-container">
                <!-- Try multiple possible logo file names -->
                <img class="logo" id="logoImage" alt="JooyMedia Logo" style="display: none;">
            </div>
            <h1 class="event-title">Lead The Future Conference 2025</h1>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="checkedInCount">0</div>
                    <div class="stat-label">Checked In</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">200</div>
                    <div class="stat-label">Total Expected</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="percentageCount">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>
        </div>

        <div class="checkin-list">
            <h2 class="list-header">üìã Recent Check-ins (Latest First)</h2>
            <div id="checkinItems">
                <div class="no-checkins">
                    Loading check-in data from Google Sheets... üîÑ
                </div>
            </div>
        </div>

        <!-- Debug information -->
        <div class="debug-info" id="debugInfo">
            <strong>üîç DETAILED DEBUG INFO:</strong><br>
            Status: Initializing...<br>
            Last fetch: Never<br>
            Total rows in sheet: 0<br>
            Displaying last: 0 entries<br>
            Sheet order: Not loaded<br>
            Logo status: Checking...
        </div>
    </div>

    <div class="connection-status loading" id="connectionStatus">
        üü° Loading...
    </div>

    <script>
        // ‚ö†Ô∏è REPLACE WITH YOUR ACTUAL GOOGLE SHEETS CSV URL
        // Alternative URL format that sometimes works better
        const GOOGLE_SHEET_ID = '1vSeVXeuJPrgKWYTGJNWOFF0jR0nz4OtEr_7Tqf40P9zlaUUyicUqKm90AT8WA8GzT2uxV5IDrCJMVjO';
        const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-${GOOGLE_SHEET_ID}/pub?output=csv`;
        
        // Backup URL format
        const BACKUP_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSeVXeuJPrgKWYTGJNWOFF0jR0nz4OtEr_7Tqf40P9zlaUUyicUqKm90AT8WA8GzT2uxV5IDrCJMVjO/pub?output=csv';
        
        let isFirstLoad = true;
        let fetchAttempts = 0;
        let lastDataCount = 0;

        // Logo loading function with multiple attempts
        function loadLogo() {
            const logoImg = document.getElementById('logoImage');
            const possibleNames = [
                'JooyMedia_logo.png',
                'JooyMedia-logo.png', 
                'jooy-media-logo.png',
                'logo.png',
                'JooyMedia.png'
            ];
            
            let attemptIndex = 0;
            
            function tryNextLogo() {
                if (attemptIndex >= possibleNames.length) {
                    updateDebugInfo('Logo: All attempts failed', [], null, 'Logo loading failed');
                    return;
                }
                
                const logoUrl = possibleNames[attemptIndex];
                logoImg.src = logoUrl;
                logoImg.onload = function() {
                    logoImg.style.display = 'block';
                    updateDebugInfo('Logo: ‚úÖ Loaded successfully (' + logoUrl + ')', [], null, 'Logo loaded');
                };
                logoImg.onerror = function() {
                    attemptIndex++;
                    setTimeout(tryNextLogo, 100);
                };
                
                updateDebugInfo('Logo: Trying ' + logoUrl, [], null, 'Attempting logo load');
            }
            
            tryNextLogo();
        }

        function updateDebugInfo(status, dataArray = [], error = null, extraInfo = '') {
            const debugElement = document.getElementById('debugInfo');
            const now = new Date().toLocaleTimeString();
            const dataCount = dataArray.length;
            
            // Show the actual order from sheet
            let sheetOrder = 'Not loaded';
            if (dataArray.length > 0) {
                sheetOrder = dataArray.map((person, index) => `${index + 1}. ${person.nricFullName || 'Unknown'}`).join(', ');
                if (sheetOrder.length > 100) {
                    sheetOrder = sheetOrder.substring(0, 100) + '...';
                }
            }
            
            debugElement.innerHTML = `
                <strong>üîç DETAILED DEBUG INFO:</strong><br>
                Status: ${status}<br>
                Last fetch: ${now}<br>
                Total rows in sheet: ${dataCount}<br>
                Displaying last: ${Math.min(5, dataCount)} entries<br>
                Sheet order: ${sheetOrder}<br>
                Fetch attempts: ${fetchAttempts}<br>
                ${extraInfo ? `Extra: ${extraInfo}<br>` : ''}
                ${error ? `‚ùå Error: ${error}<br>` : ''}
                Sheet URL: ${GOOGLE_SHEET_URL.substring(0, 50)}...
            `;
        }

        function formatTimeAgo(index) {
            // Simple time calculation based on position
            const minutesAgo = index * 3; // Each position = 3 minutes older
            if (minutesAgo < 1) return 'just now';
            if (minutesAgo < 60) return `${minutesAgo} min ago`;
            const hours = Math.floor(minutesAgo / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.floor(hours / 24)}d ago`;
        }

        function updateStats(checkedInCount) {
            document.getElementById('checkedInCount').textContent = checkedInCount;
            const percentage = Math.round((checkedInCount / 200) * 100);
            document.getElementById('percentageCount').textContent = `${percentage}%`;
        }

        function createCheckinItem(person, index, isNewest = false) {
            const item = document.createElement('div');
            item.className = `checkin-item ${isNewest ? 'newest' : ''}`;
            
            // Clean up ticket display - remove # if present
            let ticketDisplay = person.ticketID || person.ticketNumber || 'N/A';
            if (ticketDisplay.startsWith('#')) {
                ticketDisplay = ticketDisplay.substring(1);
            }
            
            item.innerHTML = `
                <div class="person-info">
                    <div class="person-name">${person.nricFullName || 'Unknown Name'}</div>
                    <div class="person-details">Ticket: ${person.ticketNumber || 'N/A'}</div>
                </div>
                <div class="ticket-info">
                    <div class="ticket-number">${ticketDisplay}</div>
                    <div class="checkin-time">${formatTimeAgo(index)}</div>
                </div>
                ${isNewest ? '<span class="new-badge">NEW!</span>' : ''}
            `;
            
            return item;
        }

        function updateCheckinDisplay(data) {
            const container = document.getElementById('checkinItems');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="no-checkins">No check-ins yet... Waiting for data from Google Sheets üìä</div>';
                updateStats(0);
                // Reset data tracking when no data
                lastDataCount = 0;
                return;
            }

            console.log('üîç DEBUGGING DATA ORDER:');
            console.log('Original data from sheet (in order):', data);
            
            // Take EXACTLY the last 5 entries from the Google Sheet
            // These represent the most recent check-ins
            const lastFiveEntries = data.slice(-5);
            
            console.log('Last 5 entries from sheet:', lastFiveEntries);
            
            // Reverse the array so the NEWEST (last row from sheet) appears FIRST on dashboard
            const displayOrder = [...lastFiveEntries].reverse();
            
            console.log('Display order (reversed for newest first):', displayOrder);
            
            // Check if we have new data (but handle deletions properly)
            const hasNewEntry = data.length > lastDataCount;
            
            // ALWAYS clear container to handle deletions properly
            container.innerHTML = '';
            
            // Add items in display order (newest first)
            displayOrder.forEach((person, index) => {
                const isNewest = hasNewEntry && index === 0 && !isFirstLoad;
                const item = createCheckinItem(person, index, isNewest);
                container.appendChild(item);
            });
            
            // Remove NEW badge after 5 seconds
            if (hasNewEntry && !isFirstLoad) {
                setTimeout(() => {
                    const newestItem = container.querySelector('.checkin-item.newest');
                    if (newestItem) {
                        newestItem.classList.remove('newest');
                        const badge = newestItem.querySelector('.new-badge');
                        if (badge) badge.remove();
                    }
                }, 5000);
            }
            
            updateStats(data.length);
            lastDataCount = data.length;
            isFirstLoad = false;
        }

        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim().replace(/^"|"$/g, ''));
            
            return result;
        }

        async function fetchGoogleSheetData() {
            fetchAttempts++;
            
            // Try primary URL first, then backup
            const urlsToTry = [GOOGLE_SHEET_URL, BACKUP_SHEET_URL];
            
            for (let urlIndex = 0; urlIndex < urlsToTry.length; urlIndex++) {
                const currentUrl = urlsToTry[urlIndex];
                
                try {
                    updateDebugInfo(`üîÑ Attempting URL ${urlIndex + 1}/2: ${currentUrl.substring(0, 50)}...`, [], null, 'Making request...');
                    
                    // STRONG cache busting to prevent stale data
                    const cacheBuster = Date.now() + Math.random().toString(36).substr(2, 9);
                    const fullUrl = currentUrl + (currentUrl.includes('?') ? '&' : '?') + `v=${cacheBuster}&cb=${cacheBuster}`;
                    
                    const response = await fetch(fullUrl, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    console.log(`Attempting to fetch: ${fullUrl}`);
                    console.log(`Response status: ${response.status}`);
                    
                    if (!response.ok) {
                        if (urlIndex === urlsToTry.length - 1) {
                            // Last URL failed
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        } else {
                            // Try next URL
                            console.log(`URL ${urlIndex + 1} failed, trying next...`);
                            continue;
                        }
                    }
                    
                    const csvText = await response.text();
                    console.log('Raw response length:', csvText.length);
                    console.log('First 200 chars:', csvText.substring(0, 200));
                    
                    if (!csvText || csvText.trim().length === 0) {
                        throw new Error('Empty response from Google Sheets');
                    }
                    
                    // Check if response looks like CSV (not HTML error page)
                    if (csvText.toLowerCase().includes('<html>') || csvText.toLowerCase().includes('<!doctype')) {
                        throw new Error('Received HTML instead of CSV - check sheet permissions');
                    }
                    
                    console.log('üìÑ Raw CSV data received:', csvText.substring(0, 300) + '...');
                    
                    // Parse CSV data
                    const rows = csvText.trim().split('\n');
                    
                    if (rows.length < 2) {
                        updateDebugInfo('Connected but no data rows', [], null, 'Only header row found');
                        // Clear display when no data rows (handles deletions)
                        updateCheckinDisplay([]);
                        document.getElementById('connectionStatus').className = 'connection-status connected';
                        document.getElementById('connectionStatus').innerHTML = 'üü¢ Connected - No Data';
                        return;
                    }
                    
                    const headers = parseCSVRow(rows[0]);
                    console.log('üìã Headers found:', headers);
                    
                    const data = [];
                    
                    // Process rows in EXACT ORDER they appear in the sheet
                    for (let i = 1; i < rows.length; i++) {
                        const values = parseCSVRow(rows[i]);
                        
                        // Only process rows with actual name data
                        if (values.length > 0 && values[0] && values[0].trim() !== '') {
                            const rowData = {
                                nricFullName: values[0]?.trim() || '',
                                emailAddress: values[1]?.trim() || '',
                                mobileNumber: values[2]?.trim() || '',
                                ticketNumber: values[3]?.trim() || '',
                                ticketID: values[4]?.trim() || ''
                            };
                            
                            if (rowData.nricFullName) {
                                data.push(rowData);
                                console.log(`Row ${i}: ${rowData.nricFullName} - ${rowData.ticketID}`);
                            }
                        }
                    }
                    
                    console.log('‚úÖ Final parsed data (sheet order):', data);
                    
                    // Always update display with current data (handles both additions and deletions)
                    updateCheckinDisplay(data);
                    updateDebugInfo(`‚úÖ SUCCESS with URL ${urlIndex + 1}`, data, null, `Found ${data.length} check-ins`);
                    
                    document.getElementById('connectionStatus').className = 'connection-status connected';
                    document.getElementById('connectionStatus').innerHTML = 'üü¢ Connected';
                    
                    return; // Success, exit the function
                    
                } catch (error) {
                    console.error(`‚ùå Error with URL ${urlIndex + 1}:`, error);
                    
                    if (urlIndex === urlsToTry.length - 1) {
                        // All URLs failed
                        updateDebugInfo('‚ùå All connection attempts failed', [], error.message, 'Check Google Sheets settings');
                        
                        document.getElementById('connectionStatus').className = 'connection-status disconnected';
                        document.getElementById('connectionStatus').innerHTML = 'üî¥ Connection Error';
                        
                        if (isFirstLoad) {
                            document.getElementById('checkinItems').innerHTML = `
                                <div class="no-checkins">
                                    ‚ùå Unable to connect to Google Sheets<br>
                                    <small>Error: ${error.message}</small><br>
                                    <small style="font-size: 0.7em; color: #999;">
                                        Try: File ‚Üí Share ‚Üí Publish to web ‚Üí Select specific sheet ‚Üí CSV format
                                    </small>
                                </div>
                            `;
                        }
                    } else {
                        console.log(`Trying backup URL...`);
                    }
                }
            }
        }

        // Load logo when page loads
        loadLogo();
        
        // Initial data load
        fetchGoogleSheetData();
        
        // Update every 3 seconds for real-time updates
        setInterval(fetchGoogleSheetData, 3000);
    </script>
</body>
</html>
