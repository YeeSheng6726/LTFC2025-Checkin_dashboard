<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Check-in Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #FF4500 0%, #FF6600 25%, #FF8C00 50%, #FFA500 75%, #FFB347 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            color: #333;
        }

        .logo-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100px;
        }

        .logo {
            max-height: 100px;
            max-width: 300px;
            width: auto;
            height: auto;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .event-title {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #FF4500;
            font-weight: bold;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #FF6600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #FF4500;
        }

        .stat-label {
            font-size: 0.9em;
            color: #333;
            font-weight: 600;
        }

        .checkin-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .list-header {
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #FF6600;
            color: #FF4500;
            font-weight: bold;
        }

        .checkin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 8px 0;
            background: white;
            border-radius: 10px;
            transition: all 0.3s ease;
            border-left: 4px solid #FF6600;
            border: 2px solid #FFB347;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            color: #333;
        }

        .checkin-item.newest {
            background: #FFF8DC;
            border-left: 4px solid #FF4500;
            border: 2px solid #FF4500;
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.4);
            transform: scale(1.02);
            animation: shake 2s ease-in-out, newItemGlow 8s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) scale(1.02); }
            25% { transform: translateX(-5px) scale(1.02); }
            75% { transform: translateX(5px) scale(1.02); }
        }

        @keyframes newItemGlow {
            0%, 100% { 
                background: #FFF8DC;
                box-shadow: 0 0 20px rgba(255, 69, 0, 0.4);
            }
            50% { 
                background: #FFEBCD;
                box-shadow: 0 0 30px rgba(255, 69, 0, 0.6);
            }
        }

        .person-info {
            flex: 1;
        }

        .person-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 3px;
            color: #333;
        }

        .person-details {
            font-size: 0.9em;
            color: #666;
        }

        .ticket-info {
            text-align: right;
            flex-shrink: 0;
        }

        .ticket-number {
            font-size: 1.4em;
            font-weight: bold;
            color: #FF4500;
            margin-bottom: 3px;
        }

        .checkin-time {
            font-size: 0.8em;
            color: #888;
        }

        .new-badge {
            background: #FF4500;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.7em;
            font-weight: bold;
            animation: pulse 1s infinite;
            margin-left: 10px;
            box-shadow: 0 2px 10px rgba(255, 69, 0, 0.5);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 2px 10px rgba(255, 69, 0, 0.5); }
            50% { transform: scale(1.1); box-shadow: 0 4px 20px rgba(255, 69, 0, 0.8); }
            100% { transform: scale(1); box-shadow: 0 2px 10px rgba(255, 69, 0, 0.5); }
        }

        .no-checkins {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
            font-weight: 600;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .connected {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }

        .disconnected {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .loading {
            background: rgba(255, 152, 0, 0.9);
            color: white;
        }

        .debug-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.8em;
            border: 2px solid #FF6600;
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .debug-info strong {
            color: #FF4500;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .event-title {
                font-size: 1.8em;
            }
            
            .logo {
                max-height: 80px;
            }
            
            .checkin-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .ticket-info {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <div class="logo-container">
                <!-- Try multiple possible logo file names -->
                <img class="logo" id="logoImage" alt="JooyMedia Logo" style="display: none;">
            </div>
            <h1 class="event-title">LEAD the Future Conference 2025</h1>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="checkedInCount">0</div>
                    <div class="stat-label">Checked In</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">150</div>
                    <div class="stat-label">Total Expected</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="percentageCount">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>
        </div>

        <div class="checkin-list">
            <h2 class="list-header">üìã Recent Check-ins (Latest First)</h2>
            <div id="checkinItems">
                <div class="no-checkins">
                    Loading check-in data from Firebase... üîÑ
                </div>
            </div>
        </div>

        <!-- Debug information -->
        <div class="debug-info" id="debugInfo">
            <strong>üîç DETAILED DEBUG INFO:</strong><br>
            Status: Initializing Firebase...<br>
            Last update: Never<br>
            Total checkins: 0<br>
            Displaying last: 0 entries<br>
            Data source: Firebase Realtime Database<br>
            Logo status: Checking...
        </div>
        <!-- CLEANUP SECTION - ADD THIS AFTER DEBUG SECTION -->
        <div style="background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 10px; margin-top: 10px; border: 2px solid #dc3545; color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
            <button onclick="resetData()" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); transition: all 0.3s ease;">
                üóëÔ∏è Clean Up Test Data
            </button>
            <br>
            <small style="color: #666; margin-top: 8px; display: block;">Use this to remove test check-ins during preparation</small>
        </div>
    </div>

    <div class="connection-status loading" id="connectionStatus">
        üü° Connecting to Firebase...
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // ‚ö†Ô∏è REPLACE THIS WITH YOUR FIREBASE CONFIG FROM STEP 3
        const firebaseConfig = {
          apiKey: "AIzaSyB_PVgf4M7vGa_MwyZt2Fmjnp2--C4pwBE",
          authDomain: "ltfc25-checkin-dashboard.firebaseapp.com",
          databaseURL: "https://ltfc25-checkin-dashboard-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "ltfc25-checkin-dashboard",
          storageBucket: "ltfc25-checkin-dashboard.firebasestorage.app",
          messagingSenderId: "263826141430",
          appId: "1:263826141430:web:338648bd21eb5675d8bcd7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let isFirstLoad = true;
        let lastDataCount = 0;
        let allCheckins = [];

        // Logo loading function with multiple attempts
        function loadLogo() {
            const logoImg = document.getElementById('logoImage');
            const possibleNames = [
                'JooyMedia_logo.png',
                'JooyMedia-logo.png', 
                'jooy-media-logo.png',
                'logo.png',
                'JooyMedia.png'
            ];
            
            let attemptIndex = 0;
            
            function tryNextLogo() {
                if (attemptIndex >= possibleNames.length) {
                    updateDebugInfo('Logo: All attempts failed', [], null, 'Logo loading failed');
                    return;
                }
                
                const logoUrl = possibleNames[attemptIndex];
                logoImg.src = logoUrl;
                logoImg.onload = function() {
                    logoImg.style.display = 'block';
                    updateDebugInfo('Logo: ‚úÖ Loaded successfully (' + logoUrl + ')', [], null, 'Logo loaded');
                };
                logoImg.onerror = function() {
                    attemptIndex++;
                    setTimeout(tryNextLogo, 100);
                };
                
                updateDebugInfo('Logo: Trying ' + logoUrl, [], null, 'Attempting logo load');
            }
            
            tryNextLogo();
        }

        function updateDebugInfo(status, dataArray = [], error = null, extraInfo = '') {
            const debugElement = document.getElementById('debugInfo');
            const now = new Date().toLocaleTimeString();
            const dataCount = dataArray.length;
            
            debugElement.innerHTML = `
                <strong>üîç DETAILED DEBUG INFO:</strong><br>
                System Status: ${status}<br>
                Last update: ${now}<br>
                Check-ins: ${dataCount}<br>
                Data source: Firebase Realtime Database
            `;
        }

        function formatTimeAgo(checkinTime) {
            try {
                const checkinDate = new Date(checkinTime);
                const now = new Date();
                const diffMinutes = Math.floor((now - checkinDate) / (1000 * 60));
                
                if (diffMinutes < 1) return 'just now';
                if (diffMinutes < 60) return `${diffMinutes} min ago`;
                
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 24) return `${diffHours}h ago`;
                
                const diffDays = Math.floor(diffHours / 24);
                return `${diffDays}d ago`;
            } catch (error) {
                return checkinTime || 'Unknown time';
            }
        }

        function updateStats(checkedInCount) {
            document.getElementById('checkedInCount').textContent = checkedInCount;
            const percentage = Math.round((checkedInCount / 200) * 100);
            document.getElementById('percentageCount').textContent = `${percentage}%`;
        }

        function createCheckinItem(person, isNewest = false) {
            const item = document.createElement('div');
            item.className = `checkin-item ${isNewest ? 'newest' : ''}`;
            
            // Clean up ticket display - remove # if present
            let ticketDisplay = person.ticketID || person.ticketNumber || 'N/A';
            if (ticketDisplay.startsWith('#')) {
                ticketDisplay = ticketDisplay.substring(1);
            }
            
            item.innerHTML = `
                <div class="person-info">
                    <div class="person-name">${person.nricFullName || 'Unknown Name'}</div>
                    <div class="person-details">Ticket: ${person.ticketNumber || 'N/A'}</div>
                </div>
                <div class="ticket-info">
                    <div class="ticket-number">${ticketDisplay}</div>
                    <div class="checkin-time">${formatTimeAgo(person.checkinTime)}</div>
                </div>
                ${isNewest ? '<span class="new-badge">NEW!</span>' : ''}
            `;
            
            return item;
        }

        function updateCheckinDisplay(data) {
            const container = document.getElementById('checkinItems');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="no-checkins">No check-ins yet... Waiting for data from Firebase üî•</div>';
                updateStats(0);
                return;
            }

            console.log('üîç DEBUGGING DATA ORDER:');
            console.log('Original data from Firebase:', data);
            
            // Take EXACTLY the last 5 entries from the data
            // These represent the most recent check-ins
            const lastFiveEntries = data.slice(-5);
            
            console.log('Last 5 entries:', lastFiveEntries);
            
            // Reverse the array so the NEWEST appears FIRST on dashboard
            const displayOrder = [...lastFiveEntries].reverse();
            
            console.log('Display order (reversed for newest first):', displayOrder);
            
            // Check if we have new data
            const hasNewEntry = data.length > lastDataCount;
            lastDataCount = data.length;
            
            // Clear container
            container.innerHTML = '';
            
            // Add items in display order (newest first)
            displayOrder.forEach((person, index) => {
                const isNewest = hasNewEntry && index === 0 && !isFirstLoad;
                const item = createCheckinItem(person, isNewest);
                container.appendChild(item);
            });
            
            // Remove NEW badge after 5 seconds
            if (hasNewEntry && !isFirstLoad) {
                setTimeout(() => {
                    const newestItem = container.querySelector('.checkin-item.newest');
                    if (newestItem) {
                        newestItem.classList.remove('newest');
                        const badge = newestItem.querySelector('.new-badge');
                        if (badge) badge.remove();
                    }
                }, 5000);
            }
            
            updateStats(data.length);
            isFirstLoad = false;
        }

        // Firebase real-time listener
        try {
            updateDebugInfo('üîÑ Connecting to Firebase...', [], null, 'Initializing connection...');
            
            const checkinsRef = ref(database, 'checkins');
            
            onValue(checkinsRef, (snapshot) => {
                try {
                    const data = snapshot.val();
                    
                    if (data) {
                        // Convert Firebase object to array (preserving order)
                        const checkinsArray = Object.keys(data)
                            .sort() // Sort by keys to maintain order
                            .map(key => ({
                                id: key,
                                ...data[key],
                                checkinTime: data[key].timestamp || data[key].checkinTime // Handle both field names
                            }));
                        
                        console.log('‚úÖ Firebase data received:', checkinsArray);
                        
                        allCheckins = checkinsArray;
                        updateCheckinDisplay(checkinsArray);
                        updateDebugInfo('‚úÖ Connected to Firebase - Real-time updates active', checkinsArray, null, `Live connection established`);
                        
                        document.getElementById('connectionStatus').className = 'connection-status connected';
                        document.getElementById('connectionStatus').innerHTML = 'üü¢ Firebase Connected';
                        
                    } else {
                        // No data yet
                        allCheckins = [];
                        updateCheckinDisplay([]);
                        updateDebugInfo('‚úÖ Connected to Firebase - No data yet', [], null, 'Waiting for first check-in...');
                        
                        document.getElementById('connectionStatus').className = 'connection-status connected';
                        document.getElementById('connectionStatus').innerHTML = 'üü¢ Firebase Ready';
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error processing Firebase data:', error);
                    updateDebugInfo('‚ùå Error processing data', [], error.message);
                }
                
            }, (error) => {
                console.error('‚ùå Firebase connection error:', error);
                updateDebugInfo('‚ùå Firebase connection failed', [], error.message);
                
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('connectionStatus').innerHTML = 'üî¥ Firebase Error';
                
                if (isFirstLoad) {
                    document.getElementById('checkinItems').innerHTML = `
                        <div class="no-checkins">
                            ‚ùå Unable to connect to Firebase<br>
                            <small>Error: ${error.message}</small>
                        </div>
                    `;
                }
            });
            
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            updateDebugInfo('‚ùå Firebase initialization failed', [], error.message);
            
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            document.getElementById('connectionStatus').innerHTML = 'üî¥ Init Error';
        }

        // Load logo when page loads
        loadLogo();

        // ADD THIS FUNCTION BEFORE </script>
        window.resetData = function() {
            if (confirm("üßπ Clean Up Test Data?\n\nThis will remove all current check-ins from the database.\nThis is useful for cleaning up after testing.\n\nProceed?")) {
                if (confirm("‚ö†Ô∏è Final Confirmation\n\nAre you sure you want to delete all check-in data?\nThis action cannot be undone.")) {
                    try {
                        import('https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js')
                            .then((module) => {
                                const { ref, remove } = module;
                                const checkinsRef = ref(database, 'checkins');
                                return remove(checkinsRef);
                            })
                            .then(() => {
                                alert("‚úÖ Success!\n\nAll test check-in data has been removed.\nDashboard reset to 0 check-ins.");
                                document.getElementById('checkinItems').innerHTML = '<div class="no-checkins">Test data cleaned up! Ready for next test or event üöÄ</div>';
                                updateStats(0);
                                updateDebugInfo('‚úÖ Test data manually cleaned up', [], null, 'Database reset - ready for fresh data');
                            })
                            .catch((error) => {
                                alert("‚ùå Cleanup Failed\n\nError: " + error.message);
                            });
                    } catch (error) {
                        alert("‚ùå Technical Error\n\nSomething went wrong: " + error.message);
                    }
                }
            }
        };
        
    </script>
</body>
</html>
