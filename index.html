<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Check-in Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #FF4500 0%, #FF6600 25%, #FF8C00 50%, #FFA500 75%, #FFB347 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            color: #333;
        }

        .event-title {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #FF4500;
            font-weight: bold;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #FF6600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #FF4500;
        }

        .stat-label {
            font-size: 0.9em;
            color: #333;
            font-weight: 600;
        }

        .checkin-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .list-header {
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #FF6600;
            color: #FF4500;
            font-weight: bold;
        }

        .checkin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 8px 0;
            background: white;
            border-radius: 10px;
            transition: all 0.3s ease;
            border-left: 4px solid #FF6600;
            border: 2px solid #FFB347;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            color: #333;
        }

        .checkin-item.newest {
            background: #FFF8DC;
            border-left: 4px solid #FF4500;
            border: 2px solid #FF4500;
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.4);
            transform: scale(1.02);
            animation: shake 0.5s ease-in-out, newItemGlow 5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) scale(1.02); }
            25% { transform: translateX(-5px) scale(1.02); }
            75% { transform: translateX(5px) scale(1.02); }
        }

        @keyframes newItemGlow {
            0%, 100% { 
                background: #FFF8DC;
                box-shadow: 0 0 20px rgba(255, 69, 0, 0.4);
            }
            50% { 
                background: #FFEBCD;
                box-shadow: 0 0 30px rgba(255, 69, 0, 0.6);
            }
        }

        .person-info {
            flex: 1;
        }

        .person-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 3px;
            color: #333;
        }

        .person-details {
            font-size: 0.9em;
            color: #666;
        }

        .ticket-info {
            text-align: right;
            flex-shrink: 0;
        }

        .ticket-number {
            font-size: 1.4em;
            font-weight: bold;
            color: #FF4500;
            margin-bottom: 3px;
        }

        .checkin-time {
            font-size: 0.8em;
            color: #888;
        }

        .new-badge {
            background: #FF4500;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.7em;
            font-weight: bold;
            animation: pulse 1s infinite;
            margin-left: 10px;
            box-shadow: 0 2px 10px rgba(255, 69, 0, 0.5);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 2px 10px rgba(255, 69, 0, 0.5); }
            50% { transform: scale(1.1); box-shadow: 0 4px 20px rgba(255, 69, 0, 0.8); }
            100% { transform: scale(1); box-shadow: 0 2px 10px rgba(255, 69, 0, 0.5); }
        }

        .no-checkins {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
            font-weight: 600;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .connected {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }

        .disconnected {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .loading {
            background: rgba(255, 152, 0, 0.9);
            color: white;
        }

        .debug-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.8em;
            border: 2px solid #FF6600;
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .debug-info strong {
            color: #FF4500;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .event-title {
                font-size: 1.8em;
            }
            
            .checkin-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .ticket-info {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1 class="event-title">üé´ Lead The Future Conference 2025</h1>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="checkedInCount">0</div>
                    <div class="stat-label">Checked In</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">300</div>
                    <div class="stat-label">Total Expected</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="percentageCount">0%</div>
                    <div class="stat-label">Progress</div>
                </div>
            </div>
        </div>

        <div class="checkin-list">
            <h2 class="list-header">üìã Recent Check-ins (Latest First)</h2>
            <div id="checkinItems">
                <div class="no-checkins">
                    Loading check-in data from Google Sheets... üîÑ
                </div>
            </div>
        </div>

        <!-- Debug information -->
        <div class="debug-info" id="debugInfo">
            <strong>Debug Info:</strong><br>
            Status: Initializing...<br>
            Last fetch: Never<br>
            Data rows: 0
        </div>
    </div>

    <div class="connection-status loading" id="connectionStatus">
        üü° Loading...
    </div>

    <script>
        // ‚ö†Ô∏è REPLACE WITH YOUR ACTUAL GOOGLE SHEETS CSV URL
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSeVXeuJPrgKWYTGJNWOFF0jR0nz4OtEr_7Tqf40P9zlaUUyicUqKm90AT8WA8GzT2uxV5IDrCJMVjO/pub?output=csv';
        
        let previousData = [];
        let isFirstLoad = true;
        let fetchAttempts = 0;
        let checkinTimestamps = new Map(); // Store when each person first checked in
        let seenParticipants = new Set(); // Track which participants we've seen before

        function updateDebugInfo(status, dataCount = 0, error = null) {
            const debugElement = document.getElementById('debugInfo');
            const now = new Date().toLocaleTimeString();
            debugElement.innerHTML = `
                <strong>Debug Info:</strong><br>
                Status: ${status}<br>
                Last fetch: ${now}<br>
                Data rows: ${dataCount}<br>
                Fetch attempts: ${fetchAttempts}<br>
                ${error ? `Error: ${error}<br>` : ''}
                Sheet URL: ${GOOGLE_SHEET_URL.substring(0, 50)}...
            `;
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000); // Convert to minutes
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes} min ago`;
            if (hours < 24) return `${hours}h ${minutes % 60}m ago`;
            return `${days}d ${hours % 24}h ago`;
        }

        function updateStats(checkedInCount) {
            document.getElementById('checkedInCount').textContent = checkedInCount;
            const percentage = Math.round((checkedInCount / 300) * 100);
            document.getElementById('percentageCount').textContent = `${percentage}%`;
        }

        function createUniqueKey(person) {
            // Create a unique identifier for each person
            return `${person.nricFullName}_${person.ticketID || person.ticketNumber}`;
        }

        function createCheckinItem(person, isNewest = false) {
            const item = document.createElement('div');
            item.className = `checkin-item ${isNewest ? 'newest' : ''}`;
            
            const uniqueKey = createUniqueKey(person);
            const timestamp = checkinTimestamps.get(uniqueKey) || new Date();
            
            item.innerHTML = `
                <div class="person-info">
                    <div class="person-name">${person.nricFullName || 'Unknown Name'}</div>
                    <div class="person-details">Ticket: ${person.ticketNumber || 'N/A'} | ID: ${person.ticketID || 'N/A'}</div>
                </div>
                <div class="ticket-info">
                    <div class="ticket-number">#${person.ticketID || person.ticketNumber || 'N/A'}</div>
                    <div class="checkin-time">${formatTimeAgo(timestamp)}</div>
                </div>
                ${isNewest ? '<span class="new-badge">NEW!</span>' : ''}
            `;
            
            return item;
        }

        function updateCheckinDisplay(data) {
            const container = document.getElementById('checkinItems');
            
            if (data.length === 0) {
                container.innerHTML = '<div class="no-checkins">No check-ins yet... Waiting for data from Google Sheets üìä</div>';
                updateStats(0);
                return;
            }

            // Track new participants and assign timestamps
            const currentParticipants = new Set();
            let hasNewEntry = false;
            let newestParticipantKey = null;

            data.forEach(person => {
                const uniqueKey = createUniqueKey(person);
                currentParticipants.add(uniqueKey);

                if (!checkinTimestamps.has(uniqueKey)) {
                    // This is a truly new participant
                    checkinTimestamps.set(uniqueKey, new Date());
                    
                    if (!isFirstLoad) {
                        hasNewEntry = true;
                        newestParticipantKey = uniqueKey;
                    }
                }
            });

            // Get last 5 entries and reverse to show newest first (by check-in time)
            const sortedData = data.slice().sort((a, b) => {
                const keyA = createUniqueKey(a);
                const keyB = createUniqueKey(b);
                const timeA = checkinTimestamps.get(keyA) || new Date(0);
                const timeB = checkinTimestamps.get(keyB) || new Date(0);
                return timeB - timeA; // Newest first
            });

            const recentCheckins = sortedData.slice(0, 5);
            
            // Clear container
            container.innerHTML = '';
            
            // Add items (newest to oldest by check-in time)
            recentCheckins.forEach((person) => {
                const uniqueKey = createUniqueKey(person);
                const isNewest = hasNewEntry && uniqueKey === newestParticipantKey;
                const item = createCheckinItem(person, isNewest);
                container.appendChild(item);
            });
            
            // Remove NEW badge and animation after 5 seconds
            if (hasNewEntry) {
                setTimeout(() => {
                    const newestItem = container.querySelector('.checkin-item.newest');
                    if (newestItem) {
                        newestItem.classList.remove('newest');
                        const badge = newestItem.querySelector('.new-badge');
                        if (badge) badge.remove();
                    }
                }, 5000);
            }
            
            updateStats(data.length);
            previousData = [...data];
            isFirstLoad = false;
        }

        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        async function fetchGoogleSheetData() {
            fetchAttempts++;
            
            try {
                updateDebugInfo('Fetching data from Google Sheets...', previousData.length);
                
                const response = await fetch(GOOGLE_SHEET_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('Empty response from Google Sheets');
                }
                
                // Parse CSV data
                const rows = csvText.trim().split('\n');
                
                if (rows.length < 2) {
                    updateDebugInfo('Google Sheets connected but no data rows found', 0);
                    updateCheckinDisplay([]);
                    document.getElementById('connectionStatus').className = 'connection-status connected';
                    document.getElementById('connectionStatus').innerHTML = 'üü¢ Connected - No Data';
                    return;
                }
                
                const headers = parseCSVRow(rows[0]);
                console.log('CSV Headers:', headers);
                
                const data = [];
                
                for (let i = 1; i < rows.length; i++) {
                    const values = parseCSVRow(rows[i]);
                    
                    if (values.length >= headers.length && values[0]) {
                        const rowData = {
                            nricFullName: values[0]?.replace(/"/g, '').trim(),
                            emailAddress: values[1]?.replace(/"/g, '').trim(),
                            mobileNumber: values[2]?.replace(/"/g, '').trim(),
                            ticketNumber: values[3]?.replace(/"/g, '').trim(),
                            ticketID: values[4]?.replace(/"/g, '').trim()
                        };
                        
                        if (rowData.nricFullName) {
                            data.push(rowData);
                        }
                    }
                }
                
                console.log('Parsed data from Google Sheets:', data);
                
                updateCheckinDisplay(data);
                updateDebugInfo('‚úÖ Successfully connected to Google Sheets', data.length);
                
                document.getElementById('connectionStatus').className = 'connection-status connected';
                document.getElementById('connectionStatus').innerHTML = 'üü¢ Connected';
                
            } catch (error) {
                console.error('Error fetching Google Sheets data:', error);
                updateDebugInfo('‚ùå Error connecting to Google Sheets', previousData.length, error.message);
                
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('connectionStatus').innerHTML = 'üî¥ Connection Error';
                
                // Show error message in the checkin area if this is the first load
                if (isFirstLoad || previousData.length === 0) {
                    document.getElementById('checkinItems').innerHTML = `
                        <div class="no-checkins">
                            ‚ùå Unable to connect to Google Sheets<br>
                            <small>Please check your Google Sheets URL and make sure it's published as CSV</small>
                        </div>
                    `;
                }
                // If we have previous data, keep showing it instead of clearing it
            }
        }

        // Update every 5 seconds
        setInterval(fetchGoogleSheetData, 5000);
        
        // Initial load
        fetchGoogleSheetData();
        
        // Update timestamps every 30 seconds
        setInterval(() => {
            const timeElements = document.querySelectorAll('.checkin-time');
            timeElements.forEach((element) => {
                const checkinItem = element.closest('.checkin-item');
                if (checkinItem) {
                    const nameElement = checkinItem.querySelector('.person-name');
                    const ticketElement = checkinItem.querySelector('.ticket-number');
                    
                    if (nameElement && ticketElement) {
                        const name = nameElement.textContent;
                        const ticket = ticketElement.textContent.replace('#', '');
                        const uniqueKey = `${name}_${ticket}`;
                        const timestamp = checkinTimestamps.get(uniqueKey);
                        
                        if (timestamp) {
                            element.textContent = formatTimeAgo(timestamp);
                        }
                    }
                }
            });
        }, 30000);
    </script>
</body>
</html>
